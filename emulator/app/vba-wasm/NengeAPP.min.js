"use strict";class MyAudio{AUDIO_BLOCK_SIZE=1024;AUDIO_FIFO_MAXLEN=4900;Ctx=new(window.AudioContext||window.webkitAudioContext)({latencyHint:1e-4,sampleRate:48e3});Psr=this.Ctx.createScriptProcessor(this.AUDIO_BLOCK_SIZE,0,2);audioLeft=new Int16Array(this.AUDIO_FIFO_MAXLEN);audioRight=new Int16Array(this.AUDIO_FIFO_MAXLEN);Num=0;Start=0;readyState=!1;constructor(e){return this.Psr.addEventListener("audioprocess",(e=>{this.state&&this.processAudio(e)})),this.Psr.connect(this.Ctx.destination),document.addEventListener("visibilitychange",(e=>{this.es&&(e.target.hidden?this.suspend():this.resume())})),(e,t)=>t?this.Play(e,t):this.open(e)}get state(){return"running"==this.Ctx.state}suspend(){return this.readyState&&this.Ctx.suspend(),!1}resume(){return this.readyState&&this.Ctx.resume(),!0}checkRun(){return 1==this.readyState||(this.Ctx.resume(),this.state&&(this.readyState=!0)),this.readyState}open(e){return this.es=!e,this.checkRun(),e?this.suspend():this.resume()}Play(e,t){var a=NengeApp.Module;if(this.state){var n=new Int16Array(a.HEAPU8.buffer).subarray(e/2,e/2+2048),i=(this.Start+this.Num)%this.AUDIO_FIFO_MAXLEN;if(!(this.Num+t>=this.AUDIO_FIFO_MAXLEN)){for(var o=0;o<t;o++)this.audioLeft[i]=n[2*o],this.audioRight[i]=n[2*o+1],i=(i+=1)%this.AUDIO_FIFO_MAXLEN;this.Num+=t}}}processAudio(e){e.inputBuffer;var t=e.outputBuffer,a=t.getChannelData(0),n=t.getChannelData(1);if(!Module.isRunning)return a[o]=Array(this.AUDIO_BLOCK_SIZE),void(n[o]=Array(this.AUDIO_BLOCK_SIZE));var i=parseInt(this.AUDIO_BLOCK_SIZE);this.Num<i&&(i=this.Num);for(var o=0;o<i;o++)a[o]=this.audioLeft[this.Start]/32768,n[o]=this.audioRight[this.Start]/32768,this.Start=(this.Start+=1)%this.AUDIO_FIFO_MAXLEN,this.Num--}}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,100)};class MyFile{FILES=[];DB=localforage;Zip=new JSZip;Jpre="core-";GPre="game-";SPre="save-";Input=document.createElement("input");Reader=new FileReader;constructor(e){var t=this.Input;t.hidden=!0,t.type="file",document.body.appendChild(this.Input),t.addEventListener("change",(e=>{var t=e.target.files[0];this.InputName=t.name,this.Reader.readAsArrayBuffer(t)})),this.Reader.addEventListener("load",(e=>{var t=new Uint8Array(e.target.result);80==t[0]&&75==t[1]?this.ReadZip(t):150==t[178]?(this.save(this.InputName,t),this.Emulator&&this.Emulator.load(this.InputName,t)):alert("无效文件，支持GBA文件和含有GBA的ZIP压缩文件")})),this.DB.ready().then((()=>{this.DB.keys().then((t=>{this.FILES=t,this.Emulator=e}))}))}open(){this.Input.click()}async load(e,t){return await this.DB.getItem(e)}async save(e,t){await this.DB.setItem(e,t),this.FILES.push(e)}async ReadZip(e){var t=this;JSZip.loadAsync(e,{optimizedBinaryString:!0,decodeFileName:e=>t.GBKtoUTF8(e)}).then((e=>{let t=t=>{e.file(t).async("uint8array").then((e=>{150==e[178]&&this.save(this.GPre+name,e)}))};for(var a in e.files)t(e.files[a])}))}GBKtoUTF8(e){let t=this,a="",n=0;for(;n<e.length;){var i=parseInt(e[n]);if(i>=32&&i<=127)a+=String.fromCharCode(e[n++]);else{var o=e[n++].toString(16),r=e[n++].toString(16),s=t.GBKcodeToUTF8(o+r);a+=!1!==s?s:decodeURI("%"+o+"%"+r+"%"+e[n++].toString(16))}}return a}}var NengeApp={ver:1,FILES:[],FPS:1e3/60,InIt:function(e){if("undefined"==typeof WebAssembly)return alert("你的浏览器不支持WASM。");var t=this,a=$(t.LAYER).parent();return e.onresize=null,e.onorientationchange=null,$(e).unbind(),t.FILE=new MyFile(this),t.EventResize.forEach((a=>{e.addEventListener(a,(function(e){t.ReSize(e)}),{passive:!1})})),t.EventAll.forEach((e=>{a[0].addEventListener(e,(function(e){e.target,e.id;t.Event(e)}),{passive:!1})})),$(".inputFile").on("change",(function(e){return t.UploadFile(e,this)})),["keydown","keyup"].forEach((a=>e.addEventListener(a,t.EventKEY,{passive:!1}))),e.addEventListener("gamepadconnected",(function(e){t.EventGamePad(e,!0)}),!1),e.addEventListener("gamepaddisconnected",(function(e){t.EventGamePad(e,!1)}),!1),t.DrawContext=$(t.CANVAS)[0].getContext("2d"),t.ReSize(),t._GetCore(),document.addEventListener("touchstart",(function(){}),!1),t},LAYER:"#GBA-layer ",CANVAS:"#GBA-canvas ",GBABTN:"#GBA-Btn ",GAMEMENU:"#GBA-GAMEMenu ",GBAMENU:"#GBA-Menu ",GBAMSG:"#GBA-Msg ",LAYERBTN:["a","b","select","start","right","left","up","down","r","l","menu","turbo","ul","ur","dl","dr"],SkinData:{BulbasaurGBA:{css:"background:#77b7ac;",portrait:{menu:{top:246,left:0,width:50,height:42},r:{top:0,left:269,width:106,height:32},a:{top:75,left:282,width:77,height:77},b:{top:139,left:206,width:77,height:83},l:{top:0,left:0,width:114,height:32},up:{top:69,left:58,width:56,height:50},left:{top:119,left:8,width:50,height:54},right:{top:119,left:109,width:54,height:54},down:{top:172,left:57,width:57,height:50},select:{top:246,left:136,width:40,height:33},start:{top:246,left:197,width:46,height:33},turbo:{top:32,left:136,width:107,height:28},size:{width:375,height:321,type:"half",img:"portrait.png"}}}},ReSize:function(){var e=this;e.ReSizeTime&&clearTimeout(e.ReSizeTime),e.ReSizeTime=setTimeout((function(){e.ToReSize()}),300)},canvasPer:1.5,makeoldCSS:function(e,t,a,n,i){return"top:"+e+"px;left:"+t+"px;width:"+a+"px;height:"+n+"px;font-size:"+i+"px;line-height:"+n+"px;"},yuanban:function(e,t,a,n){var i=this,o=Math.min(.14*Math.min(e,t),50),r=0,s=t,d=240*t/160,u=(e-d)/2;d>e&&(u=(e-(d=240*(t=s=414)/160))/2),"portrait"==a&&(d=e,(r=(s=160*e/240)+o)+7*o>t&&(r=0));var h={l:i.makeoldCSS(r+1.5*o,0,3*o,o,.7*o),r:i.makeoldCSS(r+1.5*o,e-3*o,3*o,o,.7*o),turbo:i.makeoldCSS(r,0,3*o,o,.7*o),menu:i.makeoldCSS(r,e-3*o,3*o,o,.7*o),up:i.makeoldCSS(r+3*o,o,o,o,.7*o),ul:i.makeoldCSS(r+3*o,0,o,o,.7*o),ur:i.makeoldCSS(r+3*o,2*o,o,o,.7*o),down:i.makeoldCSS(r+5*o,o,o,o,.7*o),dl:i.makeoldCSS(r+5*o,0,o,o,.7*o),dr:i.makeoldCSS(r+5*o,2*o,o,o,.7*o),left:i.makeoldCSS(r+4*o,0,o,o,.7*o),right:i.makeoldCSS(r+4*o,2*o,o,o,.7*o),a:i.makeoldCSS(r+3.5*o,e-1.3*o,1.3*o,1.3*o,.7*o),b:i.makeoldCSS(r+4*o,e-1.3*o*2.4,1.3*o,1.3*o,.7*o),select:i.makeoldCSS(t-.5*o,(e-3*o*2.2)/2,3*o,.5*o,.7*o),start:i.makeoldCSS(t-.5*o,1.2*((e-3*o*2.2)/2+3*o),3*o,.5*o,.7*o)},l="",m="."+n+" ";for(var p in h)l+=m+".vk[data-k="+p+"]{position: absolute;background:rgba(0,0,0,0.1);color:rgba(255,255,255,0.6);z-index:6;text-align:center;"+h[p]+"}";return l+=m+i.GBABTN+"{position: absolute;top:10px;margin:0px auto auto auto;left:0;text-align:center;right:0;bottom:0;z-index:5;display:inline-block;opacity:0.8;}"+m+i.CANVAS+","+m+i.GBAMSG+","+m+i.GBANAV+"{width:"+d+"px;height:"+s+"px;top:0px;left:"+u+"px;position: absolute;z-index:2;}"+m+i.GBAMENU+","+m+i.GAMEPAD+","+m+i.GAMEMENU+",.testDiv{position: absolute;background: rgb(0,0,0,0.6);z-index: 10;}"+m+".vk.vk-touched{color:rgba(0,0,0,0.6)}"+m+".vk-round{border-radius: 50%;line-height:180% !important;}"+m+".vk:hover{color:rgba(0,0,0,0.6) !important;background: rgb(255,255,255,0.3)!important;}"+m+"#game-zip,"+m+"#game-files{ height:"+(t/2-60)+"px;}"},ToReSize:function(){var e=this,t=window.innerWidth,a=window.innerHeight,n=$(e.LAYER).parent(),i=n.width(),o=n.height(),r=i>t?t:i,s=o>a||o<=0?a:o,d=r>s||r>700?"landscape":"portrait",u="";if(!e[e[d+t]]){for(var h in"portrait"==d?u+="@media only screen and (max-width: "+t+"px){\n\r":(void 0!==window.orientation&&(r=t,s=a),u+="@media only screen and (min-width: "+t+"px){\n\r"),r=r>900?900:r,e.SkinData){n.addClass(h);var l=e.SkinData[h][d];if(l){var m="."+h+" ",p=l.size,c=l.sreen,f=r/(p.width/p.height),v=r,S=v/p.width,g=f/p.height;f>=s&&(S=(v=(f=s)*(p.width/p.height))/p.width,g=f/p.height);for(var A=0;A<e.LAYERBTN.length;A++){var G=e.LAYERBTN[A],y=l[G];y&&(u+=m+" .vk[data-k="+G+"]{top:"+y.top*g+"px;left:"+y.left*S+"px;width:"+y.width*S+"px;height:"+y.height*g+"px;}")}var w=0,B=0,M=c&&"100%"!=c.width?c.width*S:v,b=c&&"100%"!=c.height?c.height*g:v/e.canvasPer,E=c&&0!=c.top?c.top*g:0,k=c&&0!=c.left?c.left*S:0;"portrait"==d?(w=b+E,u+=m+e.GBABTN+"{bottom:auto;width:100%;top:"+(w+f)+"px;}"):(b=c&&"100%"!=c.height?b:f,M=c&&"100%"!=c.width?M:f*e.canvasPer,t>v&&(B=(t-v)/2),0==k&&(k=(v-M)/2),k+=B,u+=m+e.GBABTN+"{flex-direction:row-reverse;top:3rem;bottom:auto;left:auto;right:"+B+"px;width:120px;}"+m+e.GBABTN+" button{margin:"+("portrait"==d?"":"10px 2px")+";display:inline-block}"),u+=m+e.LAYER+"{width:"+v+"px;height:"+f+"px;position: absolute;z-index:1;top:"+w+"px;left:0;right:0;overflow: hidden;margin: auto;}"+m+e.GBAMENU+","+m+e.GAMEPAD+","+m+e.GAMEMENU+",.testDiv{position: absolute;background: rgb(0,0,0,0.6);z-index: 10;width:"+r+"px;height:"+("portrait"==d?s:f)+"px;left:"+B+"px;font-size:0.5rem;}"+m+e.GBAMENU+"#game-files,"+m+e.GBAMENU+"#game-zip{padding:5px;overflow:scroll;height:"+o/2.5+"px;width:100%;}"+m+e.GBAMENU+"#game-files p{margin:3px 0px;padding:2px;text-align:left;}"+m+e.CANVAS+","+m+e.GBAMSG+","+m+e.GBANAV+"{width:"+M+"px;height:"+b+"px;top:"+E+"px;left:"+k+"px;position: absolute;z-index:2;}"+m+e.GBAMSG+","+m+e.GBANAV+"{z-index:9;background:rgba(255, 255, 255, 0.5);}"+m+e.LAYER+" .vk{background:rgba(255, 255, 255, 0.25);position: absolute;z-index:2;font-size:0;overflow: hidden;}"+m+e.LAYER+" .vk-round{border-radius: 50%;}"+m+e.GBABTN+"{position: absolute;z-index:2;display: flex; flex-wrap: wrap;justify-content: space-around;overflow:hidden;}"+m+'.vk[data-k=turbo]:after{content:"加速";position: absolute;left:0px;top:0px;font-size:1rem;width:100%;height:100%;color:#000;line-height:150%;}'+m+".vk[data-k=menu]{font-size:60% !important;line-height:150% !important}"}else u+=e.yuanban(r,s,d,h)}if(u){var R=$("<style id='"+h+t+"'>"+u+"}</style>");$("head").append(R)}$(e.LAYER).show(),e[d+t]=v}},EventResize:["resize","orientationchange"],EventClick:["mousedown","touchstart"],EventOut:["mousedown","touchstart"],EventMouse:["mousedown","mouseup","mousemove","mouseover"],EventMove:["touchmove"],EventAll:["mouseup","mouseover","mousemove","mousedown","tap","touchstart","touchmove","touchend","touchcancel","touchenter","touchleave"],Event:function(e){var t=this,a=t.Module,n=e.type,i=$(e.target),o=i.data("action"),r=i.data("k");if(-1!=t.EventClick.indexOf(n)&&("menu"==r&&a.isRunning&&a._resetCpu(),void 0!==o))return t.ActionEvent(o,i,n,e);a.isRunning&&t.SetKeyState(e,r,n)},_Keyboard:["Numpad2","Numpad1","Numpad0","NumpadDecimal","ArrowRight","ArrowLeft","ArrowUp","ArrowDown","Numpad6","Numpad3","KeyU","KeyY","KeyH","KeyJ","KeyD","KeyA","KeyW","KeyS","KeyT","KeyI"],EventKEY:function(e){var t=NengeApp,a=t.Module,n=t._Keyboard.indexOf(e.code)%10;if(a.isRunning)if(e.preventDefault(),e.stopPropagation(),"keyup"==e.type)n>=0&&(t.keyState[n]=0);else if("keydown"==e.type){if("NumpadAdd"==e.code)return t.OpenTurboMode($('div[data-k="turbo"]'));n>=0&&(t.keyState[n]=1)}},GAMEPAD:"#GBA-GAMEPAD ",EventGamePad:function(e,t){var a=this;a.Module;t?(a.EventGamePadMap||a.GetGamePadMap(),a.GamePadConnect=!0,a.showMsg("GamePad connect...手柄已连接。。。")):(a.GamePadConnect=!1,a.SetKeyStateByKey(),a.showMsg("GamePad not connect...手柄已断开。。。"))},SetGamePadMap:function(){var e=this;e.Module;e.EventGamePadMap={},$(e.GAMEPAD+"input").each((function(){var t=$(this),a=t.data("index"),n=t.val(),i=a?a.split("-"):null;"key"==i[0]&&(e.EventGamePadMap[i[1]]=n)})),localStorage.setItem("GamePadMap2",JSON.stringify(e.EventGamePadMap))},GetGamePadMap:function(){var e=this,t=(e.Module,localStorage.getItem("GamePadMap2")),a=t?JSON.parse(t):null;a&&"object"==typeof a?(e.EventGamePadMap=a,$(e.GAMEPAD+"input").each((function(){var t=$(this),a=t.data("index"),n=(t.val(),a?a.split("-"):null);"key"==n[0]&&t.val(e.EventGamePadMap[n[1]])}))):e.SetGamePadMap()},EventGamePadRunKey:{},EventGamePadAction:function(){for(var e=this,t=e.Module,a=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],n=0;n<a.length;n++)if(a[n]){var i=a[n],o=e.EventGamePadRunKey[i.id],r=[];for(var s in i)s+":"+i[s]+"<br>";if(i.connected&&t.isRunning)for(var d in i.buttons)if(1==i.buttons[d].pressed){var u=e.EventGamePadMap.indexOf(d);if("turbo"==u){e.OpenTurboMode();continue}r.push(u)}r.length>0?(e.EventGamePadRunKey[i.id]=r,e.SetKeyStateByKey(r)):o&&o.length>0&&(e.EventGamePadRunKey[i.id]=[],e.SetKeyStateByKey())}},ActionEvent:function(e,t,a,n){var i=this,o=i.Module;switch(e){case"upSrm":$("#upSrm").click();break;case"downSrm":i.DownSaveFile();break;case"upGba":$("#upGba").click();break;case"otherPage":void 0!==o.isRunning&&(o.isRunning=!1),location.href="other.html";break;case"rePage":void 0!==o.isRunning&&(o.isRunning=!1),location.href="index.html";break;case"CloseMenu":i._HideMenu(t.data("target"));break;case"SetGamePad":i.SetGamePadMap();break;case"GamePad":i.showGamePadMenu();break;case"OpenMenu":i.showGBAMenu();break;case"runGame":var r=t.parent().data("file");-1!=r.indexOf(i.GamePre)?i.RunGameByName(r):-1!=r.indexOf(i.SavePre)&&i.LoadSaveByName(r);break;case"del":i._RemoveFile(t);break;case"ReadCode":i.ReadCode();break;case"WriteCode":i.WriteCode();break;case"downZip":i.downZip(t);break;case"openMusic":var s=t.text();i.audio||(i.audio=new MyAudio(o));var d=!i.openMusicText.indexOf(s),u=i.audio(d);t.html(u?i.openMusicText[0]:i.openMusicText[1]);break}},openMusicText:["关闭音乐","启用音乐"],ReadCodeID:"#ReadCode ",WriteCodeID:"#WriteCode ",ReadCode:function(){var e=this,t=e.Module,a=$(e.ReadCodeID),n=parseInt(a.val());n&&$(e.WriteCodeID).val("0x"+(t._readU32(n)>>>0).toString(16).toUpperCase())},WriteCode:function(){var e=this,t=e.Module,a=$(e.WriteCodeID).val(),n=$(e.ReadCodeID).val();n&&parseInt(n)&&(t._writeU32(parseInt(n),parseInt(a)),$('<p><input type="text" value="'+n+":"+a+'"></input><button data-action="delcheat">删除</button></p>').appendTo("#cheat"))},_RemoveFile:function(e){var t=this,a=(t.Module,e.parent().data("file"));t.FILE.DB.removeItem(a).then((function(e){t._remove.apply(t.FILES,[a]),t.showGBAMenu()}))},_remove:function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)},_HideMenu:function(e){var t=this,a=t.Module,n=t.GBAMENU;void 0!==a.isRunning&&(a.isRunning=!0,$(t.GBABTN).show()),void 0===a.isRunning&&$(t.GBABTN).show(),e&&(n=e),$(n).hide()},DownSaveFile:function(){var e=this.Module;if(void 0!==e.isRunning){var t=new Blob([e.wasmSaveBuf],{type:"application/binary"}),a=document.createElement("a");a.href=window.URL.createObjectURL(t),a.download=this.getFileName(e.romFileName)+".srm",a.click()}},showGameMenu:function(){var e=this,t=e.Module;$("#game-code"),localStorage.getItem("code-"+t.romFileName);void 0!==t.isRunning&&(t.isRunning=!1),$(e.GBABTN).hide(),$(e.GAMEMENU).show()},showGamePadMenu:function(){var e=this.Module;void 0!==e.isRunning&&(e.isRunning=!1),$(this.GAMEPAD).show()},QcloudUrl:"",SeverZip:["精灵宝可梦绿宝石2012中文典藏版[口袋群星SP汉化组].zip"],downZip:function(e){var t=this;t.Module;return t._HideMenu(),$(t.GBABTN).hide(),$(t.GBANAV).html("<b style='color:red;'>文件正在从【能哥网】下载中，请勿退出，切换！</b>").show(),fetch((t.QcloudUrl?t.QcloudUrl:"")+$(e).text()).then((e=>e.arrayBuffer())).then((e=>t.ReadZip(new Uint8Array(e))))},showGBAMenu:function(){var e=this,t=e.Module,a="",n=Array.from(new Set(e.FILES));void 0!==t.isRunning&&(t.isRunning=!1),a+="<h3>储存记录</h3>";for(var i=0;i<n.length;i++){var o=n[i].split("-")[0],r=n[i].replace(o+"-","");switch(a+='<p data-pre="'+o+'" data-file="'+n[i]+'">',a+='<button data-action="del">删</button>',a+=r,o){case"game":case"save":a+='<button data-action="runGame">'+("game"==o?"运行游戏RunGame":"加载存档AddSrm")+"</button>";break;case"COREDATA":a+="→<b>运行数据包</b>";break}a+="</p><hr><hr>"}if(e.SeverZip){var s="<h3>可下载游戏,先执行一次绿宝石会启用RTC时钟再运行其他游戏</h3>";for(i=0;i<e.SeverZip.length;i++)s+='<button data-action="downZip">'+e.SeverZip[i]+"</button> ";e.SeverZip=null,$("#downZip").html(s)}$("#game-files").html(a),$(e.GBABTN).hide(),$(e.GBAMENU).show()},showMsg:function(e){var t=this;t.GBAMSGTime&&clearTimeout(t.GBAMSGTime),$(t.GBAMSG).html(e).show(),t.GBAMSGTime=setTimeout((function(){$(t.GBAMSG).hide()}),3e3)},showTips:function(e){var t=this;t.GBAMSGTime&&clearTimeout(t.GBAMSGTime),$(t.GBAMSG).html(e).show(),t.GBAMSGTime=setTimeout((function(){$(t.GBAMSG).hide()}),3e3)},GamePre:"game-",SavePre:"save-",getFileName:function(e,t){return t?e.substr(e.lastIndexOf("."),e.length-e.lastIndexOf(".")).toLowerCase():e.substr(0,e.lastIndexOf("."))},_GBKtoUTF8:function(e){var t=this.GBKTable.indexOf(e.toUpperCase());return-1!=t&&String.fromCharCode(t)},GBKtoUTF8:function(e){for(var t=NengeApp,a="",n=0;n<e.length;){var i=parseInt(e[n]);if(i>=32&&i<=127)a+=String.fromCharCode(e[n++]);else{var o=e[n++].toString(16),r=e[n++].toString(16),s=t._GBKtoUTF8(o+r);a+=!1!==s?s:decodeURI("%"+o+"%"+r+"%"+e[n++].toString(16))}}return a},ReadZip:function(e){var t=this;t.Module;(new JSZip).loadAsync(e,{optimizedBinaryString:!0,decodeFileName:t.GBKtoUTF8}).then((e=>t.ReadGBA(e)))},LastGame:"Last-Game",LoadSaveByName:function(e){var t=this;t.Module;t.FILE.DB.getItem(e).then((e=>t.loadSaveGame(new Uint8Array(e))))},RunGameByName:function(e){var t=this;t.Module,e=e.replace(t.GamePre,"");t.FILE.DB.getItem(t.GamePre+e).then((a=>t.RunGameData(a,e)))},RunGameData:function(e,t){var a=this;a.Module;$(a.GAMEMENU).hide(),$(a.GBAMENU).hide(),$(a.GBANAV).hide(),$(a.GBABTN).show(),a.LoadRom(e,t),-1!=a.FILES.indexOf(a.GamePre+t)||a.SaveGameByName(e,t),localStorage.setItem(a.LastGame,t)},SaveGameByName:function(e,t){var a=this;a.Module;a.FILE.DB.setItem(a.GamePre+t,e).then((function(e){a.FILES.push(a.GamePre+t)}))},GBANAV:"#GBA-Nav ",ReadGBA:function(e){var t=this,a=(t.Module,$(t.GBANAV));for(var n in a.html('<p class="zip-game-name"><button data-action="CloseMenu" data-target="'+t.GBANAV+'">关闭</button></p>'),e.files){var i=e.files[n];-1!==i.name.toLocaleUpperCase().indexOf(".GBA")&&(-1!=t.FILES.indexOf(t.GamePre+i.name)?t.ReadGBAtoShowHtml(i.name):t.ReadGBAtoDATA(i))}},ReadGBAtoDATA(e){var t=this,a=(t.Module,e.name);e.async("uint8array").then((e=>{t.SaveGameByName(new Uint8Array(e),a),t.ReadGBAtoShowHtml(a)}))},ReadGBAtoShowHtml:function(e){var t=this,a=$(t.GBANAV);$(t.GBABTN).hide();var n=a.show().html();a.html(n+'<p class="zip-game-name" data-file="'+t.GamePre+e+'"><button data-action="runGame">点击运行：'+e+"</button></p>")},UploadFile:function(e,t){var a=this,n=$(t),i=(n.val(),n.attr("id")),o=a.Module;t=t.files[0];if($(a.GBAMENU).hide(),!a.isWasmReady)return n.val(""),void a.showMsg("WASM没准备好!");if(t){var r=new FileReader;r.onload=function(e){var n=e.target.result;if("upGba"==i){o.romFileName=t.name;a.getFileName(o.romFileName,!0);var r=new Uint8Array(n);if(80==r[0]&&75==r[1])a.ReadZip(r);else{if(150!=r[178])return void alert("无效文件，支持GBA文件和ZIP类型压缩文件");a.RunGameData(r,t.name)}}else if("upSrm"==i)return a.loadSaveGame(new Uint8Array(n))},r.readAsArrayBuffer(t),n.val("")}},LoadRom:function(e,t){var a=this.Module;a.isRunning=!1,a.gameID="";for(var n=172;n<178;n++)a.gameID+=String.fromCharCode(e[n]);0!=e[172]&&"0000"!=a.gameID.substr(0,4)||(a.gameID=t),a.romFileName=t,a.HEAPU8.set(e,a.romBuffer);a._loadRom(e.length);this.loadSaveGame()},saveSaveGame:function(e){var t=this,a=t.Module;a.tmpSaveBuf.set(a.wasmSaveBuf),t.FILE.DB.setItem(t.SavePre+a.romFileName,a.tmpSaveBuf,(function(n,i){t.FILES.push(t.SavePre+a.romFileName),e(!0)}))},loadSaveGame:function(e){var t=this,a=t.Module;if(e)a.wasmSaveBuf.set(e);else{var n="save-"+a.romFileName,i=a.gameID+"-save-0",o=-1!=t.FILES.indexOf(n)?n:-1!=t.FILES.indexOf(i)&&i;if(o)return t.LoadSaveByName(o)}t.clearSaveBufState(),t._HideMenu(),a._resetCpu()},checkSaveBufState:function(){var e=this,t=e.Module;if(t.isRunning){var a=t._updateSaveBufState();1==t.lastCheckedSaveState&&0==a&&(e.showMsg("存档储存中SaveSrm。。。请勿关闭Don’t Colse！"),e.saveSaveGame((function(){}))),t.lastCheckedSaveState=a}},clearSaveBufState:function(){var e=this.Module;e.lastCheckedSaveState=0,e._updateSaveBufState()},keyList:["a","b","select","start","right","left","up","down","r","l"],keyState:new Array(10).fill(0),GetStateByKey:function(e){return this.keyList.indexOf(e)},SwitchKeyState:function(e){var t=this;t.Module;switch(e){case"ul":t.keyState[t.GetStateByKey("up")]=1,t.keyState[t.GetStateByKey("left")]=1;break;case"ur":t.keyState[t.GetStateByKey("up")]=1,t.keyState[t.GetStateByKey("right")]=1;break;case"dl":t.keyState[t.GetStateByKey("down")]=1,t.keyState[t.GetStateByKey("left")]=1;break;case"dr":t.keyState[t.GetStateByKey("down")]=1,t.keyState[t.GetStateByKey("right")]=1;break;default:t.keyState[t.GetStateByKey(e)]=1;break}},SetKeyStateByKey:function(e){var t=this;t.Module;if(t.keyState=new Array(10).fill(0),e){if("string"==typeof e)return t.SwitchKeyState(e);for(var a=0;a<e.length;a++)t.SwitchKeyState(e[a])}},EventMouseDown:!1,OpenTurboMode:function(e){var t=this,a=t.Module;e=e||$(".vk[data-k=turbo]");a.turboMode?(a.turboMode=!1,t.RunAnimation(),$(e).removeClass("vk-touched")):(a.turboMode=!0,t.RunAnimation(240),$(e).addClass("vk-touched"))},SetKeyState:function(e,t,a){var n=this;n.Module;if(e.preventDefault(),e.stopPropagation(),"turbo"==t&&-1!=n.EventClick.indexOf(a))return n.OpenTurboMode(e.target);if(-1==n.EventMouse.indexOf(a)){if("touchend"==a)return n.SetKeyStateByKey();for(var i=[],o=0;o<e.touches.length;o++){var r=e.touches[o],s=document.elementFromPoint(r.clientX,r.clientY);if(s){t=s.getAttribute("data-k"),n.keyList.indexOf(t);i.push(t)}}i.length>0&&n.SetKeyStateByKey(i)}else-1!=["mouseout","mouseup"].indexOf(a)?(n.EventMouseDown=!1,n.SetKeyStateByKey()):"mousedown"==a?(n.EventMouseDown=!0,n.SetKeyStateByKey(t)):"mouseover"==a&&1==n.EventMouseDown&&n.SetKeyStateByKey(t)},getVKState:function(){for(var e=0,t=(this.Module,0);t<10;t++)e|=this.keyState[t]<<t;return e},RunAnimation:function(e){clearInterval(this.AnimationFrameTime);var t=1e3/(e||60);this.AnimationFrameTime=setInterval((()=>this.AnimationFrame()),t)},AnimationFrame:function(e){var t=NengeApp,a=t.Module;a.isRunning&&(a.frameCnt++,a.frameCnt%60==0&&t.checkSaveBufState(),a._runFrame(t.getVKState()))},DrawFrame:function(e){var t=this.Module;this.DrawContext.putImageData(new ImageData(new Uint8ClampedArray(t.HEAPU8.buffer).subarray(e,e+153600),240,160),0,0)},WriteAudio:function(e,t){if(this.audio)return this.audio(e,t)},Ready:function(){var e=this;Module.romBuffer=Module._getBuffer(1);var t=Module._getBuffer(0);Module.wasmSaveBufLen=139264,Module.wasmSaveBuf=Module.HEAPU8.subarray(t,t+Module.wasmSaveBufLen),Module.frameCnt=0,Module.tmpSaveBuf=new Uint8Array(Module.wasmSaveBufLen),e.lowLatencyMode=!1,e.isWasmReady=!0,e.Module=Module,e.FILE.DB.ready().then((function(){e.FILE.DB.keys().then((function(t){e.FILES=t;var a=localStorage.getItem(e.LastGame);a&&-1!=e.FILES.indexOf(e.GamePre+a)&&(e.showMsg("<div style='background:#000;color:#fff;'>检测到上次玩过的：<br>"+a+"<br>请稍等，正在读取。。。</div>"),e.RunGameByName(a)),e.RunAnimation()}))})),$(e.GBABTN).show()},Module:{},_GetCore:function(e){var t=this,a=e=>{let t;switch(e){case"js":t="text/javascript";break;case"png":t="image/png";break;case"wasm":t="application/binary";break;case"css":t="text/css";break}return t},n=(e,n)=>{let i=n.split(".").pop();return t.Link[n]=URL.createObjectURL(new Blob([e],{type:a(i)})),t.Link[n]},i=e=>document.createElement(e),o=(e,a,o)=>{let r=document.head,s=i("link");s.rel=o,s.href=a?n(a,"abc.css"):t.Link[e],"icon"==o&&(s.type="image/png"),r.appendChild(s)},r=e=>{let a=document.head,n=i("script");return n.src=t.Link[e],a.appendChild(n),n},s=()=>{o("portrait.png","@media only screen and (max-width: 414px){.BulbasaurGBA #GBA-layer{background-image: url("+t.Link["portrait.png"]+");background-position: top center;background-repeat:no-repeat;background-size: contain;}}","stylesheet"),o("gba2.png",null,"apple-touch-icon"),o("gba2.png",null,"icon"),r("GBK.js"),r("a.out.js")};t.Link={},t.FILE.DB.getItem("COREDATA").then((e=>{if(e&&e.ver==t.ver){for(var a in e.files)n(e.files[a],a);s()}else t.showMsg("正在下载核心文件"),fetch("Core.zip?"+Math.random()).then((e=>e.arrayBuffer())).then((e=>{JSZip.loadAsync(e,{optimizedBinaryString:!0}).then((e=>{let a={ver:t.ver,files:{}},i=i=>{t.Link[i]="",e.file(i).async("uint8array").then((e=>{n(e,i),a.files[i]=e,(()=>{let e=!0;for(var n in t.Link)t.Link[n]&&a.files[n]||(e=!1);e&&(t.FILE.DB.setItem("COREDATA",a,(()=>{t.showMsg("记录核心文件")})),s())})()}))};for(var o in e.files)i(o)}))}))}))}}.InIt(window);window._=NengeApp,window.onerror=function(e,t,a,n,i){var o=n?"\ncolumn: "+n:"";return alert("Error: "+e+"\nurl: "+t+"\nline: "+a+(o+=i?"\nerror: "+i:"")),window.onerror=console.log,!0};